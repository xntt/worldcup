name: Ultimate Auto-Deploy Network

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©è‡ªåŠ¨åˆ·æ–°åŠ¨æ€å†…å®¹
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai Jinja2 Markdown

      - name: ğŸ§  Run AI Content Engine (Generate Sites)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python manage.py

      - name: â˜ï¸ Install Cloudflare Wrangler
        run: npm install -g wrangler

      - name: ğŸš€ Auto Deploy & Bind Domians to Cloudflare
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          cd dist
          for SITE in */; do
            # 1. æå–ç½‘å€ï¼Œæ¯”å¦‚ mx.worldcup-guide.com
            SITE=${SITE%/}
            
            # 2. ç”Ÿæˆç¬¦åˆ Cloudflare è§„èŒƒçš„é¡¹ç›®å (æŠŠç‚¹æ›¿æ¢æˆçŸ­æ¨ªçº¿)
            PROJECT_NAME=${SITE//./-} 
            
            echo "==========================================="
            echo "ğŸš€ æ­£åœ¨å…¨è‡ªåŠ¨éƒ¨ç½²: $SITE"
            echo "==========================================="

            # 3. è‡ªåŠ¨åˆ›å»º Cloudflare Pages é¡¹ç›® (å¦‚æœæœ‰äº†ä¼šè‡ªåŠ¨è·³è¿‡)
            wrangler pages project create "$PROJECT_NAME" --production-branch main || echo "âœ… é¡¹ç›®å·²å­˜åœ¨"

            # 4. ç›´æ¥æŠŠæ–‡ä»¶æ¨é€åˆ°è¯¥é¡¹ç›®
            wrangler pages deploy "$SITE" --project-name "$PROJECT_NAME"

            # 5. é»„é‡‘æ“ä½œï¼šè°ƒç”¨ API è‡ªåŠ¨ç»‘å®šä½ çš„ä¸“å±å­åŸŸåï¼
            # å¦‚æœä½ çš„åŸŸåç”± CF ç®¡ç†ï¼ŒCF è¿˜ä¼šè‡ªåŠ¨å¸®ä½ æŠŠ DNS CNAME è®°å½•åŠ ä¸Šå»ï¼Œ0äººå·¥å¹²é¢„ï¼
            curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$PROJECT_NAME/domains" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"name":"'"$SITE"'"}'
          done
